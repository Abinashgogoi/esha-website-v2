<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join ESHA Hub - Innovation Application</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons (Phosphor Icons for clean look) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        esha: {
                            dark: '#1a3244',
                            green: '#2d6a4f',
                            accent: '#40916c',
                            light: '#f8f9fa'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Utilities */
        .step-active { @apply border-esha-accent text-esha-accent; }
        .step-completed { @apply border-esha-green bg-esha-green text-white; }
        .step-inactive { @apply border-gray-300 text-gray-400; }
        
        /* Signature Canvas */
        canvas {
            touch-action: none; /* Prevent scrolling while signing */
            cursor: crosshair;
        }

        /* Smooth Transitions */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #40916c;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-esha-dark text-gray-800 min-h-screen py-8 px-4 font-sans antialiased">

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden relative">
        
        <!-- HEADER -->
        <div class="bg-esha-dark text-white p-8 text-center border-b-4 border-esha-accent relative">
            
            <!-- HOME ICON -->
            <a href="index.html" class="absolute top-6 left-6 text-gray-400 hover:text-white transition-all duration-300 flex items-center gap-2 group p-2 rounded-lg hover:bg-white/10">
                <i class="ph ph-house text-2xl group-hover:scale-110 transition-transform"></i>
                <span class="text-xs font-medium uppercase tracking-wider hidden sm:block opacity-0 sm:group-hover:opacity-100 transition-opacity -ml-1 sm:ml-0">Home</span>
            </a>

            <h1 class="text-3xl font-bold tracking-tight">Join ESHA Hub</h1>
            <p class="text-gray-400 text-sm mt-1">Innovator & Researcher Application Portal</p>

            <!-- STEPPER -->
            <div class="flex justify-center items-center mt-8 space-x-2 md:space-x-8">
                <!-- Step 1 -->
                <div class="flex flex-col items-center step-indicator" id="step-ind-1">
                    <div class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold text-sm transition-all duration-300 border-esha-accent text-esha-accent">1</div>
                    <span class="text-[10px] uppercase mt-2 font-semibold tracking-wider text-esha-accent">Agree</span>
                </div>
                <div class="w-8 h-0.5 bg-gray-200"></div>
                <!-- Step 2 -->
                <div class="flex flex-col items-center step-indicator" id="step-ind-2">
                    <div class="w-10 h-10 rounded-full border-2 border-gray-300 text-gray-400 flex items-center justify-center font-bold text-sm transition-all duration-300">2</div>
                    <span class="text-[10px] uppercase mt-2 font-semibold tracking-wider text-gray-400">Apply</span>
                </div>
                <div class="w-8 h-0.5 bg-gray-200"></div>
                <!-- Step 3 -->
                <div class="flex flex-col items-center step-indicator" id="step-ind-3">
                    <div class="w-10 h-10 rounded-full border-2 border-gray-300 text-gray-400 flex items-center justify-center font-bold text-sm transition-all duration-300">3</div>
                    <span class="text-[10px] uppercase mt-2 font-semibold tracking-wider text-gray-400">Preview</span>
                </div>
                <div class="w-8 h-0.5 bg-gray-200"></div>
                <!-- Step 4 -->
                <div class="flex flex-col items-center step-indicator" id="step-ind-4">
                    <div class="w-10 h-10 rounded-full border-2 border-gray-300 text-gray-400 flex items-center justify-center font-bold text-sm transition-all duration-300">4</div>
                    <span class="text-[10px] uppercase mt-2 font-semibold tracking-wider text-gray-400">Status</span>
                </div>
                <div class="w-8 h-0.5 bg-gray-200"></div>
                <!-- Step 5 -->
                <div class="flex flex-col items-center step-indicator" id="step-ind-5">
                    <div class="w-10 h-10 rounded-full border-2 border-gray-300 text-gray-400 flex items-center justify-center font-bold text-sm transition-all duration-300">5</div>
                    <span class="text-[10px] uppercase mt-2 font-semibold tracking-wider text-gray-400">Upload</span>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="p-6 md:p-10 min-h-[500px]">
            
            <!-- Global Error Message Container -->
            <div id="global-error" class="hidden mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 text-sm rounded shadow-sm"></div>

            <!-- === STEP 1: AGREEMENT === -->
            <div id="step-content-1" class="step-content fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-esha-dark">Membership Agreement</h2>
                    <button onclick="printAgreement()" class="text-sm px-3 py-1.5 border border-gray-300 rounded-full hover:bg-gray-50 flex items-center gap-2 text-gray-600 transition">
                        <i class="ph ph-printer text-lg"></i> Print
                    </button>
                </div>

                <div id="agreement-text" class="h-80 overflow-y-auto bg-gray-50 p-6 rounded-lg border border-gray-200 text-sm leading-relaxed text-gray-600 mb-6">
                    <h3 class="text-esha-green font-bold text-lg mb-2">ESHA Hub Terms & Values</h3>
                    <p class="mb-4">Welcome to ESHA Hub. By joining our community, you verify that you share our commitment to ethical innovation.</p>
                    
                    <h4 class="font-bold text-esha-dark mt-4">1. Core Values</h4>
                    <ul class="list-disc pl-5 mb-2 space-y-1">
                        <li><strong>Integrity:</strong> We expect transparency in all research.</li>
                        <li><strong>Collaboration:</strong> We share knowledge to grow together.</li>
                        <li><strong>Respect:</strong> Zero tolerance for discrimination or harassment.</li>
                    </ul>

                    <h4 class="font-bold text-esha-dark mt-4">2. Data & Confidentiality</h4>
                    <p class="mb-2">You agree to respect the intellectual property of fellow members. Proprietary data shared within the hub must remain confidential unless explicitly authorized for release.</p>

                    <h4 class="font-bold text-esha-dark mt-4">3. Ethical AI Use</h4>
                    <p class="mb-2">Any use of AI tools provided by ESHA Hub must adhere to our safety guidelines. Malicious use will result in immediate termination of membership.</p>
                    
                    <p class="mt-6 italic border-t pt-4 text-xs text-gray-500">Last updated: 2025-01-01. ESHA Hub Management.</p>
                </div>

                <label for="agree-checkbox" class="bg-gray-100 p-4 rounded-lg border border-gray-200 flex items-start gap-3 cursor-pointer hover:bg-gray-200 transition select-none">
                    <input type="checkbox" id="agree-checkbox" class="mt-1 w-5 h-5 text-esha-green rounded focus:ring-esha-green cursor-pointer">
                    <span class="text-sm font-semibold text-gray-700">
                        I have read and agree to ESHA's values and terms of service.
                    </span>
                </label>

                <div class="mt-8">
                    <button id="btn-next-1" disabled onclick="goToStep(2)" class="w-full py-3 rounded-lg font-bold text-white bg-gray-300 cursor-not-allowed transition-all duration-300">
                        Accept & Continue
                    </button>
                </div>
            </div>

            <!-- === STEP 2: APPLICATION FORM === -->
            <div id="step-content-2" class="step-content hidden fade-in">
                <h2 class="text-2xl font-bold text-esha-dark mb-6">Applicant Details</h2>
                
                <form id="application-form" class="space-y-5">
                    
                    <!-- Profile Picture Upload -->
                    <div class="flex items-center gap-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="relative w-20 h-20 rounded-full bg-gray-200 border-2 border-dashed border-gray-400 overflow-hidden flex-shrink-0 flex items-center justify-center group hover:border-esha-accent">
                            <img id="profile-preview-sm" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                            <i class="ph ph-user text-3xl text-gray-400" id="profile-placeholder-icon"></i>
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Profile Picture (Optional)</label>
                            <input type="file" id="profile-pic" accept="image/*" class="hidden" onchange="handleProfileSelect(this)">
                            <label for="profile-pic" class="cursor-pointer text-xs bg-white border border-gray-300 px-4 py-2 rounded hover:bg-gray-100 text-gray-700 font-semibold inline-block">
                                Upload Photo
                            </label>
                            <p class="text-[10px] text-gray-400 mt-1">Max 2MB. JPG/PNG.</p>
                        </div>
                    </div>

                    <!-- Personal Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name</label>
                            <input type="text" id="full-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-esha-green focus:border-transparent outline-none transition" placeholder="e.g. Rahul Sharma" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date of Birth</label>
                            <input type="date" id="dob" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-esha-green outline-none" required>
                        </div>
                    </div>

                    <!-- Contact -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email Address</label>
                            <input type="email" id="email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-esha-green outline-none" placeholder="name@example.com" required>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="col-span-1">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Code</label>
                                <select id="country-code" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-esha-green outline-none bg-white text-sm">
                                    <option value="" disabled selected>Code...</option>
                                    <option value="+91">IN +91</option>
                                    <option value="+1">US +1</option>
                                    <option value="+44">UK +44</option>
                                    <option disabled>──────────</option>
                                    <option value="+93">AF +93</option>
                                    <option value="+355">AL +355</option>
                                    <option value="+213">DZ +213</option>
                                    <option value="+376">AD +376</option>
                                    <option value="+244">AO +244</option>
                                    <option value="+54">AR +54</option>
                                    <option value="+374">AM +374</option>
                                    <option value="+61">AU +61</option>
                                    <option value="+43">AT +43</option>
                                    <option value="+994">AZ +994</option>
                                    <option value="+973">BH +973</option>
                                    <option value="+880">BD +880</option>
                                    <option value="+375">BY +375</option>
                                    <option value="+32">BE +32</option>
                                    <option value="+501">BZ +501</option>
                                    <option value="+229">BJ +229</option>
                                    <option value="+975">BT +975</option>
                                    <option value="+591">BO +591</option>
                                    <option value="+387">BA +387</option>
                                    <option value="+267">BW +267</option>
                                    <option value="+55">BR +55</option>
                                    <option value="+359">BG +359</option>
                                    <option value="+226">BF +226</option>
                                    <option value="+257">BI +257</option>
                                    <option value="+855">KH +855</option>
                                    <option value="+237">CM +237</option>
                                    <option value="+1">CA +1</option>
                                    <option value="+238">CV +238</option>
                                    <option value="+236">CF +236</option>
                                    <option value="+235">TD +235</option>
                                    <option value="+56">CL +56</option>
                                    <option value="+86">CN +86</option>
                                    <option value="+57">CO +57</option>
                                    <option value="+269">KM +269</option>
                                    <option value="+242">CG +242</option>
                                    <option value="+506">CR +506</option>
                                    <option value="+385">HR +385</option>
                                    <option value="+53">CU +53</option>
                                    <option value="+357">CY +357</option>
                                    <option value="+420">CZ +420</option>
                                    <option value="+45">DK +45</option>
                                    <option value="+253">DJ +253</option>
                                    <option value="+670">TL +670</option>
                                    <option value="+593">EC +593</option>
                                    <option value="+20">EG +20</option>
                                    <option value="+503">SV +503</option>
                                    <option value="+240">GQ +240</option>
                                    <option value="+291">ER +291</option>
                                    <option value="+372">EE +372</option>
                                    <option value="+251">ET +251</option>
                                    <option value="+679">FJ +679</option>
                                    <option value="+358">FI +358</option>
                                    <option value="+33">FR +33</option>
                                    <option value="+241">GA +241</option>
                                    <option value="+220">GM +220</option>
                                    <option value="+995">GE +995</option>
                                    <option value="+49">DE +49</option>
                                    <option value="+233">GH +233</option>
                                    <option value="+30">GR +30</option>
                                    <option value="+502">GT +502</option>
                                    <option value="+224">GN +224</option>
                                    <option value="+245">GW +245</option>
                                    <option value="+592">GY +592</option>
                                    <option value="+509">HT +509</option>
                                    <option value="+504">HN +504</option>
                                    <option value="+36">HU +36</option>
                                    <option value="+354">IS +354</option>
                                    <option value="+62">ID +62</option>
                                    <option value="+98">IR +98</option>
                                    <option value="+964">IQ +964</option>
                                    <option value="+353">IE +353</option>
                                    <option value="+972">IL +972</option>
                                    <option value="+39">IT +39</option>
                                    <option value="+225">CI +225</option>
                                    <option value="+1">JM +1</option>
                                    <option value="+81">JP +81</option>
                                    <option value="+962">JO +962</option>
                                    <option value="+7">KZ +7</option>
                                    <option value="+254">KE +254</option>
                                    <option value="+686">KI +686</option>
                                    <option value="+965">KW +965</option>
                                    <option value="+996">KG +996</option>
                                    <option value="+856">LA +856</option>
                                    <option value="+371">LV +371</option>
                                    <option value="+961">LB +961</option>
                                    <option value="+266">LS +266</option>
                                    <option value="+231">LR +231</option>
                                    <option value="+218">LY +218</option>
                                    <option value="+423">LI +423</option>
                                    <option value="+370">LT +370</option>
                                    <option value="+352">LU +352</option>
                                    <option value="+261">MG +261</option>
                                    <option value="+265">MW +265</option>
                                    <option value="+60">MY +60</option>
                                    <option value="+960">MV +960</option>
                                    <option value="+223">ML +223</option>
                                    <option value="+356">MT +356</option>
                                    <option value="+692">MH +692</option>
                                    <option value="+222">MR +222</option>
                                    <option value="+230">MU +230</option>
                                    <option value="+52">MX +52</option>
                                    <option value="+691">FM +691</option>
                                    <option value="+373">MD +373</option>
                                    <option value="+377">MC +377</option>
                                    <option value="+976">MN +976</option>
                                    <option value="+382">ME +382</option>
                                    <option value="+212">MA +212</option>
                                    <option value="+258">MZ +258</option>
                                    <option value="+95">MM +95</option>
                                    <option value="+264">NA +264</option>
                                    <option value="+674">NR +674</option>
                                    <option value="+977">NP +977</option>
                                    <option value="+31">NL +31</option>
                                    <option value="+64">NZ +64</option>
                                    <option value="+505">NI +505</option>
                                    <option value="+227">NE +227</option>
                                    <option value="+234">NG +234</option>
                                    <option value="+850">KP +850</option>
                                    <option value="+47">NO +47</option>
                                    <option value="+968">OM +968</option>
                                    <option value="+92">PK +92</option>
                                    <option value="+680">PW +680</option>
                                    <option value="+507">PA +507</option>
                                    <option value="+675">PG +675</option>
                                    <option value="+595">PY +595</option>
                                    <option value="+51">PE +51</option>
                                    <option value="+63">PH +63</option>
                                    <option value="+48">PL +48</option>
                                    <option value="+351">PT +351</option>
                                    <option value="+974">QA +974</option>
                                    <option value="+40">RO +40</option>
                                    <option value="+7">RU +7</option>
                                    <option value="+250">RW +250</option>
                                    <option value="+1">KN +1</option>
                                    <option value="+1">LC +1</option>
                                    <option value="+1">VC +1</option>
                                    <option value="+685">WS +685</option>
                                    <option value="+378">SM +378</option>
                                    <option value="+239">ST +239</option>
                                    <option value="+966">SA +966</option>
                                    <option value="+221">SN +221</option>
                                    <option value="+381">RS +381</option>
                                    <option value="+248">SC +248</option>
                                    <option value="+232">SL +232</option>
                                    <option value="+65">SG +65</option>
                                    <option value="+421">SK +421</option>
                                    <option value="+386">SI +386</option>
                                    <option value="+677">SB +677</option>
                                    <option value="+252">SO +252</option>
                                    <option value="+27">ZA +27</option>
                                    <option value="+82">KR +82</option>
                                    <option value="+211">SS +211</option>
                                    <option value="+34">ES +34</option>
                                    <option value="+94">LK +94</option>
                                    <option value="+249">SD +249</option>
                                    <option value="+597">SR +597</option>
                                    <option value="+268">SZ +268</option>
                                    <option value="+46">SE +46</option>
                                    <option value="+41">CH +41</option>
                                    <option value="+963">SY +963</option>
                                    <option value="+886">TW +886</option>
                                    <option value="+992">TJ +992</option>
                                    <option value="+255">TZ +255</option>
                                    <option value="+66">TH +66</option>
                                    <option value="+228">TG +228</option>
                                    <option value="+676">TO +676</option>
                                    <option value="+1">TT +1</option>
                                    <option value="+216">TN +216</option>
                                    <option value="+90">TR +90</option>
                                    <option value="+993">TM +993</option>
                                    <option value="+688">TV +688</option>
                                    <option value="+256">UG +256</option>
                                    <option value="+380">UA +380</option>
                                    <option value="+971">AE +971</option>
                                    <option value="+598">UY +598</option>
                                    <option value="+998">UZ +998</option>
                                    <option value="+678">VU +678</option>
                                    <option value="+379">VA +379</option>
                                    <option value="+58">VE +58</option>
                                    <option value="+84">VN +84</option>
                                    <option value="+967">YE +967</option>
                                    <option value="+260">ZM +260</option>
                                    <option value="+263">ZW +263</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Phone</label>
                                <input type="tel" id="phone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-esha-green outline-none" placeholder="9876543210" required>
                            </div>
                        </div>
                    </div>

                    <!-- Demographics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Gender</label>
                            <select id="gender" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-esha-green outline-none bg-white">
                                <option value="" disabled selected>Select Gender...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                                <option value="Prefer not to say">Prefer not to say</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Current Background</label>
                            <select id="background" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-esha-green outline-none bg-white">
                                <option value="" disabled selected>Select Background...</option>
                                <option value="Student">Student</option>
                                <option value="Researcher">Researcher</option>
                                <option value="Professional">Working Professional</option>
                                <option value="Entrepreneur">Entrepreneur</option>
                                <option value="Freelancer">Freelancer</option>
                                <option value="Educator">Educator</option>
                                <option value="Startup_Founder">Startup Founder</option>
                                <option value="Hobbyist">Hobbyist/Maker</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Address</label>
                        <input type="text" id="address" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-esha-green outline-none" placeholder="City, State, Country">
                    </div>

                    <!-- Core Questions -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Primary Interest Area</label>
                        <select id="interest" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-esha-green outline-none bg-white">
                            <option value="" disabled selected>Select Interest Area...</option>
                            <option value="AI_ML">Artificial Intelligence & ML</option>
                            <option value="Cybersecurity">Cybersecurity</option>
                            <option value="Space_Tech">Space Technology</option>
                            <option value="HealthTech">HealthTech</option>
                            <option value="Environment">Citizen Science & Environment</option>
                            <option value="Robotics">Robotics & Automation</option>
                            <option value="Blockchain">Blockchain & Web3</option>
                            <option value="IoT">IoT & Hardware</option>
                            <option value="Quantum">Quantum Computing</option>
                            <option value="Biotech">Biotech & Genomics</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Motivation (Why join ESHA?)</label>
                        <textarea id="motivation" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-esha-green outline-none" placeholder="Tell us what drives you..." required></textarea>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Vision (What will you build?)</label>
                        <textarea id="vision" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-esha-green outline-none" placeholder="Describe a project idea or goal..." required></textarea>
                    </div>
                </form>

                <div class="flex justify-between mt-8">
                    <button onclick="goToStep(1)" class="px-6 py-3 border border-gray-300 text-gray-600 font-semibold rounded-lg hover:bg-gray-50 transition">Back</button>
                    <button onclick="validateStep2()" class="px-8 py-3 bg-esha-green text-white font-bold rounded-lg hover:bg-opacity-90 shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">Next: Preview</button>
                </div>
            </div>

            <!-- === STEP 3: PREVIEW === -->
            <div id="step-content-3" class="step-content hidden fade-in">
                <h2 class="text-2xl font-bold text-esha-dark mb-2">Review Application</h2>
                <p class="text-gray-500 text-sm mb-6">Please verify your details before submitting.</p>

                <div class="bg-gray-50 rounded-xl p-6 border border-gray-200 space-y-6 text-sm relative overflow-hidden">
                    
                    <!-- Profile Preview Section -->
                    <div class="flex flex-col md:flex-row gap-6 items-center md:items-start border-b border-gray-200 pb-6">
                        <div class="w-24 h-24 rounded-full bg-gray-200 border-4 border-white shadow-sm overflow-hidden flex-shrink-0">
                            <img id="prev-profile-img" src="" class="w-full h-full object-cover hidden">
                            <div id="prev-profile-placeholder" class="w-full h-full flex items-center justify-center text-gray-400">
                                <i class="ph ph-user text-4xl"></i>
                            </div>
                        </div>
                        <div class="flex-1 text-center md:text-left space-y-1">
                            <h3 id="prev-name-display" class="text-xl font-bold text-gray-800">...</h3>
                            <p id="prev-role-display" class="text-esha-green font-semibold">...</p>
                            <p id="prev-email-display" class="text-gray-500 text-xs">...</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 border-b border-gray-200 pb-4">
                        <div>
                            <span class="block text-xs text-gray-400 uppercase">Phone</span>
                            <span id="prev-phone" class="font-semibold text-gray-800">...</span>
                        </div>
                        <div>
                            <span class="block text-xs text-gray-400 uppercase">Date of Birth</span>
                            <span id="prev-dob" class="font-semibold text-gray-800">...</span>
                        </div>
                        <div>
                            <span class="block text-xs text-gray-400 uppercase">Gender</span>
                            <span id="prev-gender" class="font-semibold text-gray-800">...</span>
                        </div>
                        <div>
                            <span class="block text-xs text-gray-400 uppercase">Background</span>
                            <span id="prev-background" class="font-semibold text-gray-800">...</span>
                        </div>
                        <div>
                            <span class="block text-xs text-gray-400 uppercase">Interest</span>
                            <span id="prev-interest" class="font-semibold text-esha-green">...</span>
                        </div>
                        <div>
                            <span class="block text-xs text-gray-400 uppercase">Address</span>
                            <span id="prev-address" class="font-semibold text-gray-800">...</span>
                        </div>
                    </div>
                    
                    <div>
                        <span class="block text-xs text-gray-400 uppercase mb-1">Motivation</span>
                        <p id="prev-motivation" class="text-gray-700 italic bg-white p-3 rounded border border-gray-100">...</p>
                    </div>
                    
                    <div>
                        <span class="block text-xs text-gray-400 uppercase mb-1">Vision</span>
                        <p id="prev-vision" class="text-gray-700 italic bg-white p-3 rounded border border-gray-100">...</p>
                    </div>
                </div>

                <div class="flex justify-between mt-8">
                    <button onclick="goToStep(2)" class="px-6 py-3 border border-gray-300 text-gray-600 font-semibold rounded-lg hover:bg-gray-50 transition">Edit</button>
                    <button id="btn-submit-app" onclick="submitToZoho()" class="px-8 py-3 bg-esha-green text-white font-bold rounded-lg hover:bg-opacity-90 shadow-lg transition flex items-center gap-2">
                        <span>Submit Application</span>
                        <i class="ph ph-paper-plane-right"></i>
                    </button>
                </div>
            </div>

            <!-- === STEP 4: STATUS === -->
            <div id="step-content-4" class="step-content hidden fade-in text-center py-10">
                <div class="mb-6 inline-flex p-4 bg-green-100 rounded-full text-green-600">
                    <i class="ph-fill ph-check-circle text-6xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-esha-dark mb-2">Application Received!</h2>
                <p class="text-gray-500 mb-8">Your application has been logged in our system.</p>

                <div class="inline-block bg-esha-light border-2 border-dashed border-esha-accent rounded-xl p-6 mb-8 relative group">
                    <span class="block text-xs text-gray-400 uppercase tracking-widest mb-2">Application ID</span>
                    <span id="display-app-id" class="text-3xl font-mono font-bold text-esha-dark tracking-wider">ESHA-....</span>
                    <div class="absolute -top-3 -right-3 bg-yellow-100 text-yellow-800 text-[10px] px-2 py-1 rounded font-bold uppercase border border-yellow-200">
                        Pending Manual Review
                    </div>
                </div>

                <p class="text-sm text-gray-600 mb-8 max-w-md mx-auto">
                    Please save your ID. You must now upload the required verification documents to complete the process.
                </p>

                <button id="btn-to-upload" disabled onclick="goToStep(5)" class="px-8 py-3 bg-gray-300 text-white font-bold rounded-lg transition duration-300 cursor-not-allowed">
                    Continue to Final Steps
                </button>
            </div>

            <!-- === STEP 5: UPLOAD === -->
            <div id="step-content-5" class="step-content hidden fade-in">
                <h2 class="text-2xl font-bold text-esha-dark mb-6">Final Verification</h2>
                
                <div class="space-y-6">
                    <!-- Upload Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Video Upload -->
                        <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-esha-accent transition bg-gray-50 group">
                            <i class="ph ph-video-camera text-4xl text-gray-400 group-hover:text-esha-accent mb-2"></i>
                            <h4 class="font-bold text-sm text-gray-700">Intro Video (Required)</h4>
                            <p class="text-xs text-gray-500 mb-3">Max 1 min. Introduce yourself.</p>
                            <input type="file" id="video-upload" accept="video/*" class="hidden" onchange="handleFileSelect(this, 'video-label')">
                            <label for="video-upload" id="video-label" class="cursor-pointer text-xs bg-white border border-gray-300 px-3 py-1.5 rounded hover:bg-gray-50 text-gray-600">Choose File</label>
                        </div>

                        <!-- Document Upload -->
                        <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-esha-accent transition bg-gray-50 group">
                            <i class="ph ph-file-pdf text-4xl text-gray-400 group-hover:text-esha-accent mb-2"></i>
                            <h4 class="font-bold text-sm text-gray-700">Resume/CV (Required)</h4>
                            <p class="text-xs text-gray-500 mb-3">PDF format preferred.</p>
                            <input type="file" id="docs-upload" accept=".pdf,.doc,.docx" class="hidden" onchange="handleFileSelect(this, 'docs-label')">
                            <label for="docs-upload" id="docs-label" class="cursor-pointer text-xs bg-white border border-gray-300 px-3 py-1.5 rounded hover:bg-gray-50 text-gray-600">Choose File</label>
                        </div>
                    </div>

                    <!-- Digital Signature -->
                    <div class="border border-gray-200 rounded-xl p-4 bg-white shadow-sm">
                        <h4 class="font-bold text-sm text-gray-700 mb-2">Digital Signature</h4>
                        <div class="relative border border-gray-300 rounded bg-gray-50 cursor-crosshair h-32 overflow-hidden" id="signature-container">
                            <canvas id="signature-pad" class="w-full h-full"></canvas>
                            <div class="absolute bottom-2 right-2 flex gap-2">
                                <button type="button" onclick="clearSignature()" class="text-[10px] bg-white border border-gray-300 px-2 py-1 rounded hover:text-red-500 shadow-sm">Clear</button>
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">Sign above using your mouse or finger.</p>
                    </div>
                </div>

                <div class="mt-8 flex justify-between items-center">
                    <span class="text-xs text-gray-400">ID: <span id="upload-ref-id" class="font-mono">...</span></span>
                    <button id="btn-final-submit" onclick="submitFinalUploads()" class="px-8 py-3 bg-esha-green text-white font-bold rounded-lg hover:bg-opacity-90 shadow-lg transition">
                        Submit Final
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIGURATION ---
        // Updated to your deployed Cloudflare Worker URL
        const ZOHO_WORKER_BASE = "https://esha-hub-api.abinashgogoi506.workers.dev"; 
        const ENDPOINT_CREATE = "/apply";
        const ENDPOINT_UPLOAD = "/upload";

        // --- STATE MANAGEMENT ---
        let appState = {
            step: 1,
            applicationId: null,
            formData: {},
            signatureBlob: null,
            profileImageSrc: null
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initSignaturePad();
            
            // Step 1 Checkbox Logic
            const agreeBox = document.getElementById('agree-checkbox');
            const nextBtn1 = document.getElementById('btn-next-1');
            
            if(agreeBox.checked) enableStep1Btn(nextBtn1);

            agreeBox.addEventListener('change', (e) => {
                if(e.target.checked) {
                    enableStep1Btn(nextBtn1);
                } else {
                    disableStep1Btn(nextBtn1);
                }
            });
        });

        function enableStep1Btn(btn) {
            btn.removeAttribute('disabled');
            btn.classList.remove('bg-gray-300', 'cursor-not-allowed');
            btn.classList.add('bg-esha-green', 'hover:bg-opacity-90', 'shadow-lg');
        }

        function disableStep1Btn(btn) {
            btn.setAttribute('disabled', 'true');
            btn.classList.add('bg-gray-300', 'cursor-not-allowed');
            btn.classList.remove('bg-esha-green', 'hover:bg-opacity-90', 'shadow-lg');
        }

        // --- NAVIGATION ---
        function goToStep(step) {
            // Hide all contents
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            
            // Show target
            document.getElementById(`step-content-${step}`).classList.remove('hidden');
            
            // Update Stepper UI
            updateStepperUI(step);
            
            // If going to Preview (3), populate data
            if(step === 3) populatePreview();
            
            // If going to Signature (5), adjust canvas
            if(step === 5) resizeCanvas();

            appState.step = step;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateStepperUI(currentStep) {
            for(let i=1; i<=5; i++) {
                const el = document.getElementById(`step-ind-${i}`);
                const circle = el.querySelector('div');
                const label = el.querySelector('span');
                
                // Reset
                circle.className = "w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold text-sm transition-all duration-300";
                label.className = "text-[10px] uppercase mt-2 font-semibold tracking-wider transition-colors duration-300";
                
                if(i < currentStep) {
                    // Completed
                    circle.classList.add('bg-esha-green', 'border-esha-green', 'text-white');
                    label.classList.add('text-esha-green');
                } else if(i === currentStep) {
                    // Active
                    circle.classList.add('border-esha-accent', 'text-esha-accent', 'bg-white', 'ring-2', 'ring-offset-2', 'ring-esha-accent');
                    label.classList.add('text-esha-accent');
                } else {
                    // Inactive
                    circle.classList.add('border-gray-300', 'text-gray-400');
                    label.classList.add('text-gray-400');
                }
            }
        }

        // --- VALIDATION & PREVIEW ---
        function validateStep2() {
            const requiredIds = ['full-name', 'email', 'phone', 'dob', 'motivation', 'vision', 'background', 'interest', 'gender', 'country-code'];
            let isValid = true;
            
            requiredIds.forEach(id => {
                const el = document.getElementById(id);
                if(!el.value.trim()) {
                    el.classList.add('border-red-500');
                    isValid = false;
                } else {
                    el.classList.remove('border-red-500');
                }
            });

            if(!isValid) {
                showError("Please fill in all required fields.");
                return;
            }
            
            hideError();
            goToStep(3);
        }

        function handleProfileSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    appState.profileImageSrc = e.target.result;
                    // Update small preview in Step 2
                    const img = document.getElementById('profile-preview-sm');
                    const icon = document.getElementById('profile-placeholder-icon');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    icon.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function populatePreview() {
            // Gather data from form
            appState.formData = {
                'full-name': document.getElementById('full-name').value,
                'email': document.getElementById('email').value,
                'phone': document.getElementById('country-code').value + document.getElementById('phone').value,
                'gender': document.getElementById('gender').value,
                'dob': document.getElementById('dob').value,
                'background': document.getElementById('background').value,
                'address': document.getElementById('address').value,
                'interest': document.getElementById('interest').value,
                'motivation': document.getElementById('motivation').value,
                'vision': document.getElementById('vision').value
            };

            // Update Preview Text
            document.getElementById('prev-name-display').textContent = appState.formData['full-name'];
            document.getElementById('prev-role-display').textContent = appState.formData['background'] + " • " + appState.formData['interest'];
            document.getElementById('prev-email-display').textContent = appState.formData['email'];
            
            // Standard Fields
            document.getElementById('prev-phone').textContent = appState.formData['phone'];
            document.getElementById('prev-dob').textContent = appState.formData['dob'];
            document.getElementById('prev-gender').textContent = appState.formData['gender'];
            document.getElementById('prev-background').textContent = appState.formData['background'];
            document.getElementById('prev-interest').textContent = appState.formData['interest'];
            document.getElementById('prev-address').textContent = appState.formData['address'];
            document.getElementById('prev-motivation').textContent = appState.formData['motivation'];
            document.getElementById('prev-vision').textContent = appState.formData['vision'];

            // Update Profile Image in Preview
            const prevImg = document.getElementById('prev-profile-img');
            const prevPlace = document.getElementById('prev-profile-placeholder');
            
            if (appState.profileImageSrc) {
                prevImg.src = appState.profileImageSrc;
                prevImg.classList.remove('hidden');
                prevPlace.classList.add('hidden');
            } else {
                prevImg.classList.add('hidden');
                prevPlace.classList.remove('hidden');
            }
        }

        // --- ZOHO INTEGRATION (CREATE) ---
        async function submitToZoho() {
            const btn = document.getElementById('btn-submit-app');
            const originalContent = btn.innerHTML;
            
            try {
                // UI Loading State
                btn.disabled = true;
                btn.innerHTML = '<span class="loader mr-2"></span> Processing...';
                hideError();

                let data;
                const endpoint = `${ZOHO_WORKER_BASE}${ENDPOINT_CREATE}`;

                try {
                    // Send data to Cloudflare Worker
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(appState.formData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status} ${response.statusText}`);
                    }
                    
                    data = await response.json();

                } catch (netError) {
                    // Fallback for Demo/Preview if backend is not reachable
                    console.warn(`Backend connection failed (${netError.message}). Using SIMULATION mode for demo.`);
                    await new Promise(r => setTimeout(r, 1500)); // Simulate network delay
                    data = { success: true, Application_ID: "ESHA-DEMO-" + Math.floor(Math.random() * 10000) };
                }

                if (data.success && data.Application_ID) {
                    appState.applicationId = data.Application_ID;
                    
                    // Update Step 4 UI
                    document.getElementById('display-app-id').textContent = appState.applicationId;
                    document.getElementById('upload-ref-id').textContent = appState.applicationId;
                    
                    // Enable Next Button
                    const nextBtn = document.getElementById('btn-to-upload');
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                    nextBtn.classList.add('bg-esha-green', 'hover:bg-opacity-90');
                    
                    goToStep(4);
                } else {
                    throw new Error(data.error || "Failed to generate Application ID.");
                }

            } catch (error) {
                console.error("Submission Error:", error);
                showError("Submission failed: " + error.message);
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        // --- ZOHO INTEGRATION (UPLOAD) ---
        async function submitFinalUploads() {
            if (!appState.applicationId) {
                showError("Missing Application ID. Please refresh and try again.");
                return;
            }

            const btn = document.getElementById('btn-final-submit');
            const originalContent = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="loader mr-2"></span> Uploading...';

                const formData = new FormData();
                formData.append('Application_ID', appState.applicationId);
                
                // Append Files
                const videoFile = document.getElementById('video-upload').files[0];
                const docFile = document.getElementById('docs-upload').files[0];
                const profileFile = document.getElementById('profile-pic').files[0];
                
                if (videoFile) formData.append('video', videoFile);
                if (docFile) formData.append('agreement', docFile);
                if (profileFile) formData.append('profile_picture', profileFile);

                // Append Signature
                if (appState.signatureBlob) {
                    formData.append('signature', appState.signatureBlob, 'signature.png');
                }

                let data;
                const endpoint = `${ZOHO_WORKER_BASE}${ENDPOINT_UPLOAD}`;

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status} ${response.statusText}`);
                    }

                    data = await response.json();
                } catch (netError) {
                     // Fallback for Demo/Preview
                    console.warn(`Backend connection failed (${netError.message}). Using SIMULATION mode for demo.`);
                    await new Promise(r => setTimeout(r, 2000));
                    data = { success: true };
                }

                if (data.success) {
                    alert("Application Complete! Your submission is under review.");
                    location.reload();
                } else {
                    throw new Error(data.error || "Upload failed");
                }

            } catch (error) {
                console.error("Upload Error:", error);
                showError("Upload failed. Please ensure file sizes are under limit.");
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        // --- SIGNATURE CANVAS ---
        let canvas, ctx;

        function initSignaturePad() {
            canvas = document.getElementById('signature-pad');
            ctx = canvas.getContext('2d');
            
            // Handle resizing
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            let drawing = false;

            function startDraw(e) {
                drawing = true;
                ctx.beginPath();
                const pos = getPos(e);
                ctx.moveTo(pos.x, pos.y);
            }
            
            function endDraw() {
                if(drawing) {
                    drawing = false;
                    canvas.toBlob(blob => appState.signatureBlob = blob);
                }
            }

            function draw(e) {
                if (!drawing) return;
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }

            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                return {
                    x: (clientX - rect.left) * (canvas.width / rect.width),
                    y: (clientY - rect.top) * (canvas.height / rect.height)
                };
            }

            // Mouse Events
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseleave', endDraw);

            // Touch Events (Mobile)
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e); }, { passive: false });
            canvas.addEventListener('touchend', (e) => { e.preventDefault(); endDraw(); }, { passive: false });
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }, { passive: false });
        }

        function resizeCanvas() {
            // High DPI scaling
            const container = document.getElementById('signature-container');
            if(!container) return; // Guard if on other steps
            
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = container.offsetWidth * ratio;
            canvas.height = container.offsetHeight * ratio;
            ctx.scale(ratio, ratio);
            
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
        }

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            appState.signatureBlob = null;
        }

        // --- UTILS ---
        function handleFileSelect(input, labelId) {
            const label = document.getElementById(labelId);
            if (input.files && input.files[0]) {
                label.textContent = input.files[0].name;
                label.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
            }
        }

        function showError(msg) {
            const el = document.getElementById('global-error');
            el.textContent = msg;
            el.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function hideError() {
            document.getElementById('global-error').classList.add('hidden');
        }

        function printAgreement() {
            const printContent = document.getElementById('agreement-text').innerHTML;
            const win = window.open('', '', 'height=700,width=700');
            win.document.write('<html><head><title>Agreement</title>');
            win.document.write('</head><body style="font-family: sans-serif; padding: 20px;">');
            win.document.write(printContent);
            win.document.write('</body></html>');
            win.document.close();
            win.print();
        }
    </script>
</body>
</html>
